name: Publish Manuscript

# Set the access for individual scopes, or use permissions: write-all
permissions:
  pull-requests: write
  issues: write
  repository-projects: write

on:
  workflow_dispatch:
    inputs:
      doi:
        required: true
        description: Preprint DOI
      msid:
        required: true
        description: Manuscript ID
      dateReviewedPreprint:
        description: Reviewed Preprint posted (YYYY-MM-DD)
      datePostedToPreprintServer:
        required: true
        description: Posted to preprint server (YYYY-MM-DD)
      urlPostedOnPreprintServer:
        required: true
        description: Posted to preprint server (url)
      preprintServer:
        description: Preprint server
      dateSentForPeerReview:
        required: true
        description: Sent for peer review (YYYY-MM-DD)
      msa:
        description: Subject areas (comma separated)
      urlPdf:
        description: PDF location (url)
      versionManuscript:
        description: Manuscript version

jobs:
  publish-manuscript:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Read .nvmrc
        run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_OUTPUT
        id: nvm
      - name: Use Node.js (.nvmrc)
        uses: actions/setup-node@v3
        with:
          node-version: "${{ steps.nvm.outputs.NVMRC }}"
          cache: yarn
      - name: yarn install
        run: yarn
      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Create Feature Branch
        run: |
          BRANCH_NAME=feature/${{ steps.vars.outputs.sha_short }}
          git checkout -b $BRANCH_NAME
      - name: Publish Manuscript
        run: |
          yarn publish-manuscript \
            --doi "${{ github.event.inputs.doi }}" \
            --msid "${{ github.event.inputs.msid }}" \
            --dateReviewedPreprint "${{ github.event.inputs.dateReviewedPreprint }}" \
            --datePostedToPreprintServer "${{ github.event.inputs.datePostedToPreprintServer }}" \
            --urlPostedOnPreprintServer "${{ github.event.inputs.urlPostedOnPreprintServer }}" \
            --preprintServer "${{ github.event.inputs.preprintServer }}" \
            --dateSentForPeerReview "${{ github.event.inputs.dateSentForPeerReview }}" \
            --msa "${{ github.event.inputs.msa }}" \
            --urlPdf "${{ github.event.inputs.urlPdf }}" \
            --versionManuscript ${{ github.event.inputs.versionManuscript }}
      - name: Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "Publish manuscript using workflow"
      - name: Push Feature Branch
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ env.GITHUB_TOKEN }}
          branch: $BRANCH_NAME
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          head: $BRANCH_NAME
          title: "Publish manuscript ${{ github.event.inputs.msid }}"
          base: master
          body:
            |
            Manuscript ID: ${{ github.event.inputs.msid }}
            DOI: ${{ github.event.inputs.doi }}

            Please review and merge this feature branch to master.
          token: ${{ env.GITHUB_TOKEN }}
